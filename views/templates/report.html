<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Code Review</title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- 1. Google Fonts에서 Fira Code 포함 -->
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
  
  <!-- Highlight.js vs 테마 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/vs.min.css">

  <!-- Marked.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  
  <style>
    /* 기본 box-sizing 설정 */
    * {
      box-sizing: border-box;
    }

    /* body가 기본 컨테이너 역할 */
    body {
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;           /* 화면 전 높이 */
      width: 100vw;            /* 화면 전 너비 */
      overflow-x: hidden;      /* 가로로 넘치지 않도록 숨김 */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      color: #37352f;
      background: #fff;
    }
    
    /* 사이드바: 기본(가로) 환경에서 왼쪽 고정, 25vw ~ (250px~500px) 범위 */
    .sidebar {
      width: 25vw;   
      min-width: 250px;
      max-width: 500px;
      background: #f3f3f3;
      padding: 16px;
      border-right: 1px solid #e3e3e3;
      overflow-y: auto;        /* 내용이 많으면 세로 스크롤 */
      flex-shrink: 0;          /* 축소 방지 */
      height: 100%;            /* 부모(body) 높이 100% 차지 */
    }

    .sidebar h2 {
      margin-top: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .hljs-comment {
      color: #008000 !important;  /* 예: 초록색 */
      font-style: italic;         /* 기울임체 적용 (선택) */
    }

    /* 드롭다운 스타일 */
    .notion-dropdown {
      position: relative;
      background: #fafafa;
      border: 1px solid #e3e3e3;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
      color: #444;
      min-width: 120px;
    }
    .notion-dropdown::after {
      content: '▾';
      float: right;
      color: #999;
    }
    .notion-dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: #fff;
      border: 1px solid #e3e3e3;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
      z-index: 999;
    }
    .notion-dropdown-menu.active {
      display: block;
    }
    .notion-dropdown-menu div {
      padding: 8px;
      font-size: 14px;
      color: #333;
    }
    .notion-dropdown-menu div:hover {
      background: #f0f0f0;
    }
    .disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .dropdowns {
      display: flex;
      gap: 20px;
      justify-content: flex-start;
      margin-bottom: 20px;
    }
    .logo-container {
      text-align: center;
      margin-bottom: 20px;
    }

    /* 우측 메인 컨테이너 */
    .container {
      flex: 1;
      margin: 0;
      padding: 24px;
      display: flex;
      flex-direction: column;
      overflow: hidden;    /* 내부에서 처리 */
      height: 100%;        /* body 100vh 중 사이드바 제외 나머지 높이 */
    }

    /* content-wrapper: 코드/리포트 섹션 감싸는 컨테이너 */
    .content-wrapper {
      display: flex;
      gap: 20px;
      flex: 1 1 auto;
      margin-bottom: 30px;
      overflow: hidden; /* 개별 섹션에서 스크롤 처리 */
    }

    /* 코드 섹션과 리포트 섹션 */
    .code-section, .report-section {
      display: flex;
      flex-direction: column;
      flex: 1 1 0;
      min-width: 0; /* flex 자식이 가로 공간을 넘어가면 줄어들 수 있도록 */
      /* overflow: hidden; */
    }

    .code-section h3, .report-section h3 {
      margin-bottom: 8px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* 코드 블록 스타일 */
    .code-block {
      background: #f6f8fa;
      border-radius: 6px;
      padding: 8px;
      border: none;
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      overflow: auto;  /* 내부 스크롤 */
    }
    .code-language-label {
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .code-block pre {
      margin: 0;
      white-space: pre;       /* 코드 가로 스크롤 허용 */
      overflow-x: auto;
      word-break: normal;     /* 긴 문자열을 자르지 않고 스크롤 */
    }

    /* 탭 헤더 */
    .tabs {
      display: flex;
      border-bottom: 1px solid #e3e3e3;
      margin-bottom: 16px;
    }
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      background-color: #fafafa;
      margin-right: 5px;
      border-top-left-radius: 6px;
      border-top-right-radius: 6px;
      white-space: nowrap;
    }
    .tab.active {
      background-color: #fff;
      border-color: #e3e3e3 #e3e3e3 #fff #e3e3e3;
      font-weight: 600;
    }

    /* 탭 콘텐츠 영역 */
    .tab-content {
      display: none;
      flex: 1 1 auto;
      overflow: auto; /* 내부 report-block에서 스크롤 */
    }
    .tab-content.active {
      display: block;
    }

    /* 리포트 블록 스타일 */
    .report-block {
      background-color: #fff;
      border: 1px solid #e3e3e3;
      border-radius: 6px;
      padding: 8px;
      min-height: 200px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      flex: 1;
      overflow: auto;  /* 내부 스크롤 */
      font-size: 16px;
      line-height: 1.2;
      color: #37352f;
      white-space: pre-wrap;
      overflow:auto;
    }

    /* 리포트 영역 내 마진 최소화 */
    .report-block p,
    .report-block h1,
    .report-block h2,
    .report-block h3,
    .report-block h4,
    .report-block h5,
    .report-block h6,
    .report-block ul,
    .report-block ol,
    .report-block blockquote,
    .report-block pre {
      margin-top: 2px;
      margin-bottom: 2px;
      padding: 0;
      overflow-x: auto;
    }
    .report-block li {
      margin: 0;
      padding: 0 0 0 20px;
    }

    /* 코드 내의 in-line code */
    .report-block code, .code-block code {
      font-family: 'Fira Code', monospace;
      font-weight: 500;
      font-size: 13px;
      background-color: #f6f8fa;
      padding: 2px 4px;
      border-radius: 4px;
    }

    /* 파일 탐색기 스타일 */
    ul {
      list-style: none;
      padding-left: 10px;
      margin: 0;
    }
    .folder-item, .file-item {
      margin: 4px 0;
      padding: 4px;
      border-radius: 4px;
      user-select: none;
    }
    .folder-item {
      font-weight: 600;
      cursor: pointer;
    }
    .file-item {
      font-weight: normal;
      cursor: pointer;
    }
    .file-item:hover {
      background: #e8e8e8;
    }
    .file-item.active {
      background: #d8d8d8;
      font-weight: 600;
    }
    .folder-arrow {
      width: 16px;
      display: inline-block;
      text-align: center;
      margin-right: 4px;
    }
    .folder-contents {
      margin-left: 8px;
      padding-left: 12px;
      border-left: 2px dotted #ccc;
    }
    .collapsed {
      display: none;
    }
    .empty-state {
      color: #999;
      font-size: 14px;
      font-style: italic;
    }

    /* 
      ↓ 세로가 긴(portrait) 환경에서 
         - 사이드바를 왼쪽 고정, 100% 높이
         - 코드/리포트를 수직(위/아래)으로 50%씩
         - 가로 방향 스크롤 발생하지 않도록 조정
    */
    @media (orientation: portrait) {
      body {
        flex-direction: row; /* 사이드바는 왼쪽, 컨테이너는 오른쪽 */
        overflow-x: hidden;  /* 가로 스크롤 숨김 */
      }
      .sidebar {
        height: 100vh;       /* 세로 전체(뷰포트) 차지 */
        max-height: none;    /* 제한 해제 */
      }
      .container {
        width: auto;
        height: 100vh;       /* 세로 전체(뷰포트) 차지 */
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .content-wrapper {
        flex-direction: column; 
        flex: 1;
        gap: 0;              /* 위아래로 이어붙임 */
      }
      .code-section, .report-section {
        flex: 0 0 50%;       /* 각각 높이의 50% */
        width: 100%;         /* 가로는 100% 차지 */
        overflow: hidden;    /* 내부에서 스크롤 처리 */
      }
      .code-block, .report-block {
        overflow: auto;      /* 내부 스크롤 */
      }
    }

    /* 
      ↓ 모바일 or 화면 폭이 매우 좁은 경우(최대 600px)
         - 사이드바를 상단, 그 아래에 코드/리포트 순서 
         - portrait보다 우선 적용할지, 혹은 나중 적용할지는 상황에 따라 결정 가능
         - 여기서는 "portrait" 미디어쿼리가 마지막에 있으므로, 작은화면+세로 = portrait 규칙이 우선할 것
    */
    @media (max-width: 500px) {
      body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: 20vh;
        max-height: 20vh;
        border-right: none;
        border-bottom: 1px solid #e3e3e3;
      }
      .container {
        flex: 1;
        height: auto;
        overflow: auto;
      }
      .content-wrapper {
        flex-direction: column;
        gap: 20px;
      }
      .code-section, .report-section {
        width: 100%;
        height: 50%;
        flex: auto;
      }
    }

    /* 이미지가 영역을 벗어나지 않도록 */
    .report-block img, .code-block img {
      max-width: 100%;
      /* height: auto; */
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>File Explorer</h2>
    <div id="fileExplorer">
      <div class="empty-state">Select user & repository to load files.</div>
    </div>
  </div>

  <div class="container">
    <div class="logo-container">
      <img src="/static/images/kt_ds_logo.png" alt="Company Logo" style="max-width:100px;">
    </div>

    <div class="dropdowns">
      <div class="notion-dropdown" id="usersDropdown">
        <span id="usersSelected">Select User</span>
        <div class="notion-dropdown-menu" id="usersMenu">
          {% for u in users %}
            <div class="users-option" data-user="{{ u }}">{{ u }}</div>
          {% endfor %}
        </div>
      </div>

      <div class="notion-dropdown disabled" id="reposDropdown">
        <span id="reposSelected">Select Repository</span>
        <div class="notion-dropdown-menu" id="reposMenu"></div>
      </div>
    </div>

    <div class="content-wrapper">
      <!-- 원본 코드 섹션 -->
      <div class="code-section">
        <h3>원본 코드</h3>
        <div class="code-block">
          <div class="code-language-label"></div>
          <pre><code id="codeArea"></code></pre>
        </div>
      </div>

      <!-- 분석 및 코드 개선 섹션 -->
      <div class="report-section">
        <!-- 탭 헤더 -->
        <div class="tabs">
          <div class="tab active" data-tab="analysis">분석</div>
          <div class="tab" data-tab="improvement">코드 개선</div>
        </div>

        <!-- 탭 콘텐츠 -->
        <div class="tab-content active" id="analysis">
          <div class="report-block" id="analysisBlock">
            파일을 선택하세요...
          </div>
        </div>
        <div class="tab-content" id="improvement">
          <div class="report-block" id="improvementBlock">
            파일을 선택하세요...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Highlight.js 라이브러리 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const usersDropdown = document.getElementById('usersDropdown');
      const usersMenu = document.getElementById('usersMenu');
      const usersSelected = document.getElementById('usersSelected');

      const reposDropdown = document.getElementById('reposDropdown');
      const reposMenu = document.getElementById('reposMenu');
      const reposSelected = document.getElementById('reposSelected');

      const fileExplorer = document.getElementById('fileExplorer');
      const codeArea = document.getElementById('codeArea');
      const analysisBlock = document.getElementById('analysisBlock');
      const improvementBlock = document.getElementById('improvementBlock');
      const labelElement = document.querySelector('.code-language-label');

      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');

      let currentUser = null;
      let currentRepo = null;

      /* 드롭다운 토글 */
      function toggleMenu(menu) {
        menu.classList.toggle('active');
      }
      usersDropdown.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleMenu(usersMenu);
      });
      document.addEventListener('click', () => {
        usersMenu.classList.remove('active');
        reposMenu.classList.remove('active');
      });
      
      document.querySelectorAll('.users-option').forEach(opt => {
        opt.addEventListener('click', (e) => {
          e.stopPropagation();
          const user = opt.getAttribute('data-user');
          usersSelected.textContent = user;
          currentUser = user;
          usersMenu.classList.remove('active');
          reposDropdown.classList.remove('disabled');
          reposSelected.textContent = "Select Repository";
          reposMenu.innerHTML = '';

          fetch(`/get-suboptions/${user}`)
            .then(res => res.json())
            .then(repos => {
              if (repos.length > 0) {
                repos.forEach(r => {
                  const div = document.createElement('div');
                  div.textContent = r;
                  div.className = 'repo-option';
                  div.dataset.repo = r;
                  div.addEventListener('click', (e) => {
                    e.stopPropagation();
                    reposSelected.textContent = r;
                    reposMenu.classList.remove('active');
                    currentRepo = r;
                    loadTreeData(currentUser, currentRepo);
                  });
                  reposMenu.appendChild(div);
                });
              } else {
                const div = document.createElement('div');
                div.textContent = "No Repositories";
                div.style.color = '#999';
                reposMenu.appendChild(div);
              }
            });
        });
      });

      reposDropdown.addEventListener('click', (e) => {
        if (!reposDropdown.classList.contains('disabled')) {
          e.stopPropagation();
          toggleMenu(reposMenu);
        }
      });

      /* 트리 데이터 가져오기 */
      function loadTreeData(user, repo) {
        fetch(`/get-tree/${user}/${repo}`)
          .then(res => res.json())
          .then(treeData => {
            renderFileExplorer(treeData);
          });
      }

      /* 사이드바 파일 탐색기 렌더링 */
      function renderFileExplorer(tree) {
        fileExplorer.innerHTML = '';
        const ul = renderTree(tree);
        fileExplorer.appendChild(ul);

        bindFolderToggle(fileExplorer);
        bindFileClick(fileExplorer);
      }

      function renderTree(tree, currentPath = '') {
        const ul = document.createElement('ul');

        for (let folderName in tree.folders) {
          const li = document.createElement('li');
          li.className = 'folder-item';

          const arrow = document.createElement('span');
          arrow.className = 'folder-arrow';
          arrow.textContent = '▾';

          li.appendChild(arrow);
          li.appendChild(document.createTextNode(folderName));

          const contents = document.createElement('div');
          contents.className = 'folder-contents';

          const newPath = currentPath ? currentPath + '/' + folderName : folderName;
          contents.appendChild(renderTree(tree.folders[folderName], newPath));

          li.appendChild(contents);
          ul.appendChild(li);
        }

        tree.files.forEach(fileName => {
          const li = document.createElement('li');
          li.className = 'file-item';

          const fullPath = currentPath ? currentPath + '/' + fileName : fileName;
          li.dataset.fileId = fullPath; 
          li.textContent = fileName;
          ul.appendChild(li);
        });

        return ul;
      }

      function bindFolderToggle(root) {
        root.querySelectorAll('.folder-item').forEach(folder => {
          folder.addEventListener('click', (e) => {
            e.stopPropagation();
            const contents = folder.querySelector(':scope > .folder-contents');
            const arrow = folder.querySelector(':scope > .folder-arrow');
            if (contents && arrow) {
              contents.classList.toggle('collapsed');
              arrow.textContent = contents.classList.contains('collapsed') ? '▸' : '▾';
            }
          });
        });
      }

      function bindFileClick(root) {
        root.querySelectorAll('.file-item').forEach(fileItem => {
          fileItem.addEventListener('click', (e) => {
            e.stopPropagation();
            root.querySelectorAll('.file-item').forEach(i => i.classList.remove('active'));
            fileItem.classList.add('active');
            const fileId = fileItem.dataset.fileId;
            loadFileData(currentUser, currentRepo, fileId);
          });
        });
      }

      /* 파일 데이터 로드 */
      function loadFileData(user, repo, filename) {
        codeArea.innerHTML = '로딩 중...';
        analysisBlock.innerHTML = '로딩 중...';
        improvementBlock.innerHTML = '로딩 중...';
        labelElement.textContent = '';

        fetch(`/file-data/${user}/${repo}/${filename}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Network response was not ok (${response.status})`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              const language = data.language || 'plaintext';
              
              let highlightedCode = '';
              try {
                highlightedCode = hljs.highlight(data.code, { language }).value;
              } catch (err) {
                console.error('Highlighting error:', err);
                // 하이라이팅 실패 시 자동으로 언어 추론
                highlightedCode = hljs.highlightAuto(data.code).value;
              }
              
              codeArea.innerHTML = highlightedCode;
              labelElement.textContent = language.toUpperCase();

              // 분석 섹션
              const analysisContent = data.report;
              if (analysisContent) {
                try {
                  analysisBlock.innerHTML = marked.parse(analysisContent);
                  analysisBlock.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                  });
                } catch (err) {
                  console.error('Analysis parsing error:', err);
                  analysisBlock.textContent = '분석 데이터를 로드하는 중 오류가 발생했습니다.';
                }
              } else {
                analysisBlock.textContent = '분석 데이터가 없습니다.';
              }

              // 코드 개선 섹션
              const improvementContent = data.code_review;
              if (improvementContent) {
                try {
                  improvementBlock.innerHTML = marked.parse(improvementContent);
                  improvementBlock.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                  });
                } catch (err) {
                  console.error('Code Improvement parsing error:', err);
                  improvementBlock.textContent = '코드 개선 데이터를 로드하는 중 오류가 발생했습니다.';
                }
              } else {
                improvementBlock.textContent = '코드 개선 데이터가 없습니다.';
              }

              setActiveTab('analysis');
            } else {
              codeArea.textContent = '';
              analysisBlock.textContent = '해당 파일 정보가 없습니다.';
              improvementBlock.textContent = '해당 파일 정보가 없습니다.';
              labelElement.textContent = 'UNKNOWN';
            }
          })
          .catch(error => {
            console.error('Fetch error:', error);
            codeArea.textContent = '';
            analysisBlock.textContent = '파일 데이터를 로드하는 중 오류가 발생했습니다.';
            improvementBlock.textContent = '파일 데이터를 로드하는 중 오류가 발생했습니다.';
            labelElement.textContent = 'UNKNOWN';
          });
      }

      /* 탭 전환 */
      function setActiveTab(tabName) {
        tabs.forEach(tab => {
          if (tab.dataset.tab === tabName) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });

        tabContents.forEach(content => {
          if (content.id === tabName) {
            content.classList.add('active');
          } else {
            content.classList.remove('active');
          }
        });
      }

      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const selectedTab = tab.dataset.tab;
          setActiveTab(selectedTab);
        });
      });
    });
  </script>
</body>
</html>